{"version":3,"sources":["../../generator/vhosts.js"],"names":[],"mappings":"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","file":"vhosts.js","sourcesContent":["import 'colors';\n\nimport _          from 'lodash';\nimport fs         from 'fs-extra';\nimport path       from 'path';\nimport handlebars from 'handlebars';\n\n\nhandlebars.registerHelper('compare', function (lvalue, operator, rvalue, options) {\n  let operators;\n  let result;\n\n  if (3 > arguments.length) {\n    throw new Error('Handlerbars Helper \"compare\" needs 2 parameters');\n  }\n\n  if (undefined === options) {\n    options  = rvalue;\n    rvalue   = operator;\n    operator = '===';\n  }\n\n  operators = {\n    '==' (l, r) {\n      return l == r;\n    },\n    '===' (l, r) {\n      return l === r;\n    },\n    '!=' (l, r) {\n      return l != r;\n    },\n    '!==' (l, r) {\n      return l !== r;\n    },\n    '<' (l, r) {\n      return l < r;\n    },\n    '>' (l, r) {\n      return l > r;\n    },\n    '<=' (l, r) {\n      return l <= r;\n    },\n    '>=' (l, r) {\n      return l >= r;\n    },\n    'typeof' (l, r) {\n      return typeof l == r;\n    },\n  };\n\n  if (!operators[operator]) {\n    throw new Error(`Handlerbars Helper 'compare' doesn't know the operator ${operator}`);\n  }\n\n  result = operators[operator](lvalue, rvalue);\n  return result ? options.fn(this) : options.inverse(this);\n});\n\nhandlebars.registerHelper('domain', function (value) {\n  if (_.isString(value)) {\n    return value;\n  }\n\n  if (_.isArray(value)) {\n    return value.join(' ');\n  }\n});\n\nexport default function ({ LOG_PATH, ROOT_PATH, DIST_PATH, MODULES }) {\n  const TMPL_FILE   = path.join(ROOT_PATH, 'generator/templates/vhosts/nginx.conf.hbs');\n  const OUTPUT_FILE = path.join(ROOT_PATH, 'vhosts/nginx.conf');\n\n  let template = fs.readFileSync(TMPL_FILE, 'utf-8');\n  let fn       = handlebars.compile(template);\n\n  let exists = [];\n  let datas  = MODULES\n  .filter((row) => {\n    if (-1 !== _.indexOf(exists, row.domain)) {\n      console.error(`Module ${row.domain} is already exists.`.red);\n      return false;\n    }\n\n    if (!_.isString(row.domain) && !_.isArray(row.domain)) {\n      console.error('Module domain must be a string or array'.red);\n      return false;\n    }\n\n    if ('proxy' === row.type) {\n      if (!(_.isArray(row.entries) && row.entries.length > 0)) {\n        console.error('Entries must be a array, and size not less than 1.'.red);\n        return false;\n      }\n\n      if (!(_.isString(row.proxy) && /^(\\d{1,2}|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d{1,2}|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d{1,2}|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d{1,2}|1\\d\\d|2[0-4]\\d|25[0-5])$/.exec(row.proxy))) {\n        console.warn('Proxy is requied, and must be proxy ip address. it would auto set proxy to 127.0.0.1'.yellow);\n        row.proxy = '127.0.0.1';\n      }\n\n      if (!_.isNumber(row.proxyPort)) {\n        console.warn('Proxy port is requied, and must be a number it would auto set proxy port to 3030'.yellow);\n        row.proxyPort = 3030;\n      }\n    }\n\n    if (_.isArray(row.domain)) {\n      _.forEach(row.domain, function (domain) {\n        console.log(`Server config ${domain} is ok.\\n`.green);\n      });\n    }\n    else {\n      console.log(`Server config ${row.domain} is ok.\\n`.green);\n    }\n\n    exists.push(row.domain);\n    return true;\n  })\n  .map((row) => {\n    if (_.isArray(row.entries)) {\n      return Object.assign({}, row, {\n        division: row.entries.join('|'),\n      });\n    }\n\n    return row;\n  });\n\n  let logsDir = path.join(ROOT_PATH, LOG_PATH);\n  fs.ensureDirSync(logsDir);\n\n  let source = fn({\n    rootDir   : path.join(ROOT_PATH, DIST_PATH),\n    logsDir   : logsDir,\n    modules   : datas,\n  });\n\n  fs.ensureDir(OUTPUT_FILE.replace(path.basename(OUTPUT_FILE), ''));\n  fs.writeFileSync(OUTPUT_FILE, source);\n\n  console.log(`Nginx config file ${OUTPUT_FILE} is generated successfully`.green);\n  console.log('Remember reload/restart yr nginx server.'.yellow);\n}\n"]}